import openpyxl

# Cargar el archivo Excel
archivo = "ruta/al/archivo.xlsx"
wb = openpyxl.load_workbook(archivo)
hoja = wb.active  # Cambiar si es necesario a la hoja que quieras trabajar

# Paso 1: Simular arrastrar fórmulas de C3 y D3 hacia abajo
for fila in range(3, hoja.max_row + 1):  # Desde la fila 3 hasta la última fila con datos
    # Fórmulas originales en C3 y D3
    formula_c3 = hoja['C3'].value  # Obtener fórmula de la celda C3
    formula_d3 = hoja['D3'].value  # Obtener fórmula de la celda D3
    
    # Modificar las fórmulas dinámicamente para cada fila
    nueva_formula_c = formula_c3.replace('3', str(fila))
    nueva_formula_d = formula_d3.replace('3', str(fila))
    
    # Asignar las nuevas fórmulas a las celdas Cn y Dn
    hoja[f'C{fila}'] = nueva_formula_c
    hoja[f'D{fila}'] = nueva_formula_d

# Guardar temporalmente con las fórmulas arrastradas
wb.save("ruta/archivo_actualizado_con_formulas.xlsx")

# Paso 2: Volver a abrir el archivo con las fórmulas ya evaluadas
wb = openpyxl.load_workbook("ruta/archivo_actualizado_con_formulas.xlsx", data_only=True)
hoja = wb.active

# Paso 3: Reemplazar las fórmulas por los valores
for fila in range(3, hoja.max_row + 1):
    # Obtener los valores calculados (evaluados) de las celdas Cn y Dn
    valor_celda_c = hoja[f'C{fila}'].value
    valor_celda_d = hoja[f'D{fila}'].value
    
    # Volver a abrir el archivo original para escribir los valores
    wb_original = openpyxl.load_workbook(archivo)
    hoja_original = wb_original.active
    
    # Asignar los valores en lugar de las fórmulas
    hoja_original[f'C{fila}'] = valor_celda_c
    hoja_original[f'D{fila}'] = valor_celda_d

# Paso 1: Agregar un filtro a la cabecera (suponiendo que está en la fila 1)
hoja.auto_filter.ref = hoja.dimensions  # Aplicar el filtro a todas las columnas con datos

# Paso 2: Aplicar filtro específicamente a la columna K (columna 11)
hoja.auto_filter.add_filter_column(10, ["TRUE"])  # En Python, las columnas empiezan desde 0 (10 corresponde a 'K')

# Guardar el archivo final con los valores
wb_original.save("ruta/archivo_final_con_valores.xlsx")

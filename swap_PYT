import os
import re
import pdfplumber

def extraer_texto_pdf(pdf_path):
    """Extrae el texto de un archivo PDF usando pdfplumber"""
    texto = ""
    with pdfplumber.open(pdf_path) as pdf:
        for page in pdf.pages:
            texto += page.extract_text()
    return texto

def normalizar_cuil(cuil):
    """Quita cualquier espacio o carácter extraño del CUIL"""
    return re.sub(r'\s+', '', cuil)  # Elimina espacios en blanco

def renombrar_pdfs_por_cuil(cuil_file, pdf_folder):
    # Leer el archivo de CUILs
    with open(cuil_file, 'r') as file:
        cuils = [line.strip() for line in file.readlines()]
    
    # Normalizar los CUILs (remover espacios y asegurar formato correcto)
    cuils_normalizados = [normalizar_cuil(cuil) for cuil in cuils]
    
    # Recorrer todos los archivos PDF en la carpeta
    for filename in os.listdir(pdf_folder):
        if filename.endswith('.pdf'):
            pdf_path = os.path.join(pdf_folder, filename)
            
            # Extraer el texto del PDF
            texto_pdf = extraer_texto_pdf(pdf_path)
            texto_normalizado = normalizar_cuil(texto_pdf)  # Eliminar espacios en el texto extraído
            
            # Buscar si alguno de los CUILs está en el texto del PDF
            for cuil in cuils_normalizados:
                if cuil in texto_normalizado:
                    # Si se encuentra el CUIL, renombrar el archivo PDF
                    nuevo_nombre = f"{cuil}.pdf"
                    nuevo_path = os.path.join(pdf_folder, nuevo_nombre)
                    os.rename(pdf_path, nuevo_path)
                    print(f"Archivo {filename} renombrado a {nuevo_nombre}")
                    break

# Rutas de archivo y carpeta
cuil_file = 'ruta/al/salida_cuil.txt'
pdf_folder = 'ruta/a/la/carpeta/de/pdfs'

renombrar_pdfs_por_cuil(cuil_file, pdf_folder)

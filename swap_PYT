import openpyxl

archivo = "C:/Users/45133928/Desktop/ESPWR100.xlsx"

# Cargar el archivo Excel
wb = openpyxl.load_workbook(archivo)
hoja = wb.active

# Encontrar el último dato en la hoja
ultima_fila = hoja.max_row

# 1. Simular F2 y Enter para las fórmulas en las columnas L a P
for col in ['L', 'M', 'N', 'O', 'P']:
    for fila in range(2, ultima_fila + 1):  # Empezamos desde la fila 2
        celda = hoja[f"{col}{fila}"]
        # Esto guarda nuevamente la fórmula como texto que será efectivizada en Excel
        if isinstance(celda.value, str) and celda.value.startswith('='):
            celda.value = celda.value  # Reasignamos la fórmula para que sea efectiva

# 2. Copiar y pegar los valores de la columna O
for fila in range(2, ultima_fila + 1):
    celda_o = hoja[f"O{fila}"]
    if celda_o.data_type == 'f':  # Si la celda tiene una fórmula
        valor = celda_o.value
        hoja[f"O{fila}"] = celda_o.value  # Reemplazamos la fórmula con su valor

# 3. Agregar un filtro en la columna P y filtrar por TRUE
# Primero, aplicamos el filtro a todas las columnas.
hoja.auto_filter.ref = hoja.dimensions
# Luego, añadimos el filtro para que solo muestre filas donde la columna P es TRUE
hoja.auto_filter.add_filter_column(15, ["TRUE"])  # La columna P es la 16ª (índice 15)

# Guardar el archivo actualizado
wb.save(archivo)

print("Proceso completado: fórmulas actualizadas, valores pegados y filtro aplicado.")

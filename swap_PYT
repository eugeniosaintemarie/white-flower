import pandas as pd
from datetime import datetime
from dateutil.relativedelta import relativedelta

ruta_archivo = "C:/Users/Administrator/Desktop/Base.xlsx"
df = pd.read_excel(ruta_archivo)

df["FECHA_EFECTO"] = pd.to_datetime(
    df["FECHA_EFECTO"].astype(str), format="%Y%m%d", errors="coerce"
)
df["FECHA_PROXIMO_AUMENTO"] = pd.to_datetime(
    df["FECHA_PROXIMO_AUMENTO"].astype(str), format="%Y%m%d", errors="coerce"
)

FECHA_ACTUAL = datetime.now()


def calcular_fecha_proximo_aumento(FECHA_EFECTO, FRECUENCIA):
    if pd.isnull(FECHA_EFECTO) or pd.isnull(FRECUENCIA):
        return None
    FECHA_AUMENTO = FECHA_EFECTO + relativedelta(months=+FRECUENCIA)

    while FECHA_AUMENTO <= FECHA_ACTUAL:
        FECHA_AUMENTO += relativedelta(months=+FRECUENCIA)

    return FECHA_AUMENTO


df["Fecha_Calculada_Aumento"] = df.apply(
    lambda row: calcular_fecha_proximo_aumento(row["FECHA_EFECTO"], row["FRECUENCIA"]),
    axis=1,
)

df["FECHA_EFECTO"] = df["FECHA_EFECTO"].dt.strftime("%Y%m%d")
df["FECHA_PROXIMO_AUMENTO"] = df["FECHA_PROXIMO_AUMENTO"].dt.strftime("%Y%m%d")
df["Fecha_Calculada_Aumento"] = df["Fecha_Calculada_Aumento"].dt.strftime("%Y%m%d")

df["Diferencia"] = df["Fecha_Calculada_Aumento"] != df["FECHA_PROXIMO_AUMENTO"]

columnas_ordenadas = [col for col in df.columns if col != "Fecha_Calculada_Aumento"] + [
    "Fecha_Calculada_Aumento"
]
df = df[columnas_ordenadas]

df.to_excel(ruta_archivo, index=False)

print("Archivo procesado y sobreescrito con Ã©xito.")

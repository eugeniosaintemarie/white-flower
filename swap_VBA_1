Dim piezas(1 To 4, 1 To 4) As Boolean
Dim piezaActual(1 To 4, 1 To 4) As Boolean
Dim fila As Integer
Dim columna As Integer
Dim totalLineas As Integer
Dim juegoActivo As Boolean

Sub IniciarJuego()
    ' Inicialización de variables
    fila = 1
    columna = 5
    totalLineas = 0
    juegoActivo = True
    ' Limpiar pantalla
    Cells.Clear
    ' Establecer bordes visibles
    With Range("A1:J20")
        .Borders(xlEdgeBottom).LineStyle = xlContinuous
        .Borders(xlEdgeRight).LineStyle = xlContinuous
    End With
    ' Generar la pieza inicial
    GenerarPieza
    ' Mostrar estadísticas
    ActualizarEstadisticas
    ' Iniciar el ciclo de movimiento de la pieza
    LlamarMoverPieza
End Sub

Sub LlamarMoverPieza()
    ' Movimiento de la pieza cada 0.5 segundos
    On Error Resume Next
    Do While juegoActivo
        If Not MoverPieza Then Exit Do
        VerificarLineas
        ActualizarEstadisticas
        Application.Wait (Now + TimeValue("0:00:01"))
    Loop
    MsgBox "Game Over! Puntuación: " & totalLineas
End Sub

Sub GenerarPieza()
    ' Definir una pieza aleatoria
    Dim i As Integer, j As Integer
    Dim piezaTipo As Integer
    piezaTipo = Int(Rnd * 7) + 1 ' Aleatorio entre 1 y 7
    
    ' Limpiar pieza actual
    For i = 1 To 4
        For j = 1 To 4
            piezaActual(i, j) = False
        Next j
    Next i
    
    ' Dependiendo del tipo de pieza
    Select Case piezaTipo
        Case 1 ' I
            piezaActual(1, 1) = True
            piezaActual(1, 2) = True
            piezaActual(1, 3) = True
            piezaActual(1, 4) = True
        Case 2 ' O
            piezaActual(1, 1) = True
            piezaActual(1, 2) = True
            piezaActual(2, 1) = True
            piezaActual(2, 2) = True
        Case 3 ' T
            piezaActual(1, 2) = True
            piezaActual(2, 1) = True
            piezaActual(2, 2) = True
            piezaActual(3, 2) = True
        Case 4 ' L
            piezaActual(1, 2) = True
            piezaActual(2, 2) = True
            piezaActual(3, 2) = True
            piezaActual(3, 1) = True
        Case 5 ' J
            piezaActual(1, 2) = True
            piezaActual(2, 2) = True
            piezaActual(3, 2) = True
            piezaActual(3, 3) = True
        Case 6 ' Z
            piezaActual(1, 2) = True
            piezaActual(2, 2) = True
            piezaActual(2, 1) = True
            piezaActual(3, 1) = True
        Case 7 ' S
            piezaActual(1, 1) = True
            piezaActual(1, 2) = True
            piezaActual(2, 2) = True
            piezaActual(2, 3) = True
    End Select
End Sub

Function MoverPieza() As Boolean
    ' Verificar si la pieza puede moverse hacia abajo
    Dim i As Integer, j As Integer
    Dim puedeMover As Boolean
    puedeMover = True

    ' Verificar si la pieza se mueve sin colisiones
    For i = 1 To 4
        For j = 1 To 4
            If piezaActual(i, j) Then
                If fila + i > 20 Or columna + j > 10 Or columna + j < 1 Then
                    puedeMover = False
                End If
                If fila + i > 20 Then
                    puedeMover = False ' Colisión con el fondo
                End If
            End If
        Next j
    Next i

    ' Si puede moverse, moverla
    If puedeMover Then
        ' Limpiar la posición anterior
        For i = 1 To 4
            For j = 1 To 4
                If piezaActual(i, j) Then
                    Cells(fila + i - 1, columna + j - 1).Interior.Color = RGB(255, 255, 255)
                End If
            Next j
        Next i
        
        ' Mover la pieza hacia abajo
        fila = fila + 1
        
        ' Dibujar la nueva posición
        For i = 1 To 4
            For j = 1 To 4
                If piezaActual(i, j) Then
                    Cells(fila + i - 1, columna + j - 1).Interior.Color = RGB(0, 255, 0)
                End If
            Next j
        Next i
        MoverPieza = True
    Else
        ' Si no puede moverse, guardar la pieza y generar una nueva
        For i = 1 To 4
            For j = 1 To 4
                If piezaActual(i, j) Then
                    Cells(fila + i - 1, columna + j - 1).Interior.Color = RGB(0, 255, 0)
                End If
            Next j
        Next i
        ' Aquí es donde el juego "termina" si no hay espacio para una nueva pieza
        If fila = 1 Then
            juegoActivo = False ' No puede generar una nueva pieza
            Exit Function
        End If
        GenerarPieza
        fila = 1
        columna = 5
        MoverPieza = True
    End If
End Function

Sub VerificarLineas()
    Dim i As Integer, j As Integer
    Dim esCompleta As Boolean

    ' Verificar si alguna línea está completa
    For i = 1 To 20
        esCompleta = True
        For j = 1 To 10
            If Cells(i, j).Interior.Color = RGB(255, 255, 255) Then
                esCompleta = False
                Exit For
            End If
        Next j

        ' Si la línea está completa, la borramos y movemos las demás
        If esCompleta Then
            For j = 1 To 10
                Cells(i, j).Interior.Color = RGB(255, 255, 255) ' Limpiar la línea
            Next j

            ' Mover todas las piezas encima una fila hacia abajo
            For k = i To 2 Step -1
                For j = 1 To 10
                    If Cells(k - 1, j).Interior.Color <> RGB(255, 255, 255) Then
                        Cells(k, j).Interior.Color = Cells(k - 1, j).Interior.Color
                        Cells(k - 1, j).Interior.Color = RGB(255, 255, 255)
                    End If
                Next j
            Next k

            ' Aumentar el contador de líneas
            totalLineas = totalLineas + 1
        End If
    Next i
End Sub

Sub ActualizarEstadisticas()
    ' Muestra las estadísticas (líneas eliminadas)
    Range("K1").Value = "Líneas eliminadas: " & totalLineas
    Range("K1").Font.Color = RGB(255, 255, 255)
    Range("K1").Font.Size = 14
    Range("K1").Interior.Color = RGB(0, 0, 0)
End Sub

Sub Rotar()
    ' Rotar la pieza actual
    Dim nuevaPieza(1 To 4, 1 To 4) As Boolean
    Dim i As Integer, j As Integer

    ' Rotar la pieza 90 grados (transposición)
    For i = 1 To 4
        For j = 1 To 4
            nuevaPieza(i, j) = piezaActual(4 - j + 1, i)
        Next j
    Next i

    ' Verificar si la pieza rota colisiona
    If PuedeMoverPieza(nuevaPieza) Then
        piezaActual = nuevaPieza
        MoverPieza
    End If
End

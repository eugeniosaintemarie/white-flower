Dim fila As Integer
Dim columna As Integer
Dim piezaActual(1 To 4, 1 To 4) As Boolean
Dim juegoActivo As Boolean
Dim totalLineas As Integer
Dim tiempo As Double
Dim teclas As String ' Variable para detectar teclas presionadas

Sub IniciarJuego()
    ' Inicializamos el juego y las variables
    fila = 1
    columna = 5
    totalLineas = 0
    juegoActivo = True
    teclas = ""
    GenerarPieza
    MoverPieza
    tiempo = Now
    LlamarMoverPieza
    ActualizarEstadisticas
End Sub

Sub GenerarPieza()
    ' Genera una nueva pieza aleatoria
    Dim i As Integer, j As Integer
    ' Limpiar la pieza actual
    For i = 1 To 4
        For j = 1 To 4
            piezaActual(i, j) = False
        Next j
    Next i
    
    ' Definir una pieza en forma de "T" (puedes agregar más formas aquí)
    piezaActual(1, 2) = True
    piezaActual(2, 1) = True
    piezaActual(2, 2) = True
    piezaActual(2, 3) = True
End Sub

Sub MoverPieza()
    ' Borra la pieza de su ubicación actual en la cuadrícula
    Dim i As Integer, j As Integer
    For i = 1 To 4
        For j = 1 To 4
            If piezaActual(i, j) Then
                Cells(fila + i - 1, columna + j - 1).Interior.ColorIndex = -4142 ' Vuelve a color normal
            End If
        Next j
    Next i
    
    ' Dibuja la pieza en su nueva ubicación
    For i = 1 To 4
        For j = 1 To 4
            If piezaActual(i, j) Then
                Cells(fila + i - 1, columna + j - 1).Interior.Color = RGB(0, 255, 0) ' Color verde
            End If
        Next j
    Next i
End Sub

Sub LlamarMoverPieza()
    If juegoActivo Then
        ' Llamar a MoverAbajo cada 1 segundo
        If Now - tiempo >= TimeValue("00:00:01") Then
            tiempo = Now
            MoverAbajo
        End If
        ' Comprobar teclas presionadas
        If teclas = "LEFT" Then MoverIzquierda
        If teclas = "RIGHT" Then MoverDerecha
        If teclas = "DOWN" Then MoverAbajo
        If teclas = "UP" Then Rotar
        teclas = "" ' Limpiar la tecla presionada
        Application.OnTime Now + TimeValue("00:00:01"), "LlamarMoverPieza"
    End If
End Sub

Sub AsignarTeclas()
    ' Asignar las teclas de movimiento en un evento de temporizador.
    Application.OnKey "^({UP})", "TeclaArriba"
    Application.OnKey "^({RIGHT})", "TeclaDerecha"
    Application.OnKey "^({LEFT})", "TeclaIzquierda"
    Application.OnKey "^({DOWN})", "TeclaAbajo"
    Application.OnKey "^({ESC})", "FinalizarJuego" ' Escape para finalizar
End Sub

Sub TeclaIzquierda()
    teclas = "LEFT"
End Sub

Sub TeclaDerecha()
    teclas = "RIGHT"
End Sub

Sub TeclaAbajo()
    teclas = "DOWN"
End Sub

Sub TeclaArriba()
    teclas = "UP"
End Sub

Sub MoverDerecha()
    If PuedeMoverPieza(1, 0) Then
        columna = columna + 1
        MoverPieza
    End If
End Sub

Sub MoverIzquierda()
    If PuedeMoverPieza(-1, 0) Then
        columna = columna - 1
        MoverPieza
    End If
End Sub

Sub MoverAbajo()
    If PuedeMoverPieza(0, 1) Then
        fila = fila + 1
        MoverPieza
    Else
        FijarPieza
        VerificarLineas
        GenerarPieza
        fila = 1
        columna = 5
    End If
End Sub

Sub Rotar()
    Dim tempPieza(1 To 4, 1 To 4) As Boolean
    Dim i As Integer, j As Integer
    
    ' Rotamos la pieza 90 grados
    For i = 1 To 4
        For j = 1 To 4
            tempPieza(i, j) = piezaActual(5 - j, i)
        Next j
    Next i
    
    ' Comprobamos si la pieza rota puede caber en la cuadrícula
    If PuedeMoverPieza(0, 0, tempPieza) Then
        For i = 1 To 4
            For j = 1 To 4
                piezaActual(i, j) = tempPieza(i, j)
            Next j
        Next i
        MoverPieza
    End If
End Sub

Function PuedeMoverPieza(desplazamientoX As Integer, desplazamientoY As Integer, Optional nuevaPieza As Variant) As Boolean
    If IsMissing(nuevaPieza) Then
        nuevaPieza = piezaActual
    End If
    
    Dim i As Integer, j As Integer
    For i = 1 To 4
        For j = 1 To 4
            If nuevaPieza(i, j) Then
                If Cells(fila + i + desplazamientoY - 1, columna + j + desplazamientoX - 1).Interior.ColorIndex <> -4142 Then
                    PuedeMoverPieza = False
                    Exit Function
                End If
            End If
        Next j
    Next i
    PuedeMoverPieza = True
End Function

Sub FijarPieza()
    ' Fija la pieza en la cuadrícula
    Dim i As Integer, j As Integer
    For i = 1 To 4
        For j = 1 To 4
            If piezaActual(i, j) Then
                Cells(fila + i - 1, columna + j - 1).Interior.Color = RGB(0, 255, 0) ' Color de la pieza
            End If
        Next j
    Next i
End Sub

Sub VerificarLineas()
    Dim i As Integer, j As Integer
    Dim lineaCompleta As Boolean
    For i = 1 To 20
        lineaCompleta = True
        For j = 1 To 10
            If Cells(i, j).Interior.ColorIndex = -4142 Then
                lineaCompleta = False
                Exit For
            End If
        Next j
        If lineaCompleta Then
            BorrarLinea(i)
            totalLineas = totalLineas + 1
            ActualizarEstadisticas
        End If
    Next i
End Sub

Sub BorrarLinea(linea As Integer)
    Dim i As Integer, j As Integer
    For j = 1 To 10
        Cells(linea, j).Interior.ColorIndex = -4142 ' Borrar la línea
    Next j
    ' Bajar las líneas superiores
    For i = linea To 2 Step -1
        For j = 1 To 10
            Cells(i, j).Interior.Color = Cells(i - 1, j).Interior.Color
        Next j
    Next i
End Sub

Sub ActualizarEstadisticas()
    ' Muestra la cantidad de líneas completadas
    Cells(22, 1).Value = "Líneas: " & totalLineas
End Sub

Sub FinalizarJuego()
    juegoActivo = False
    MsgBox "Juego Terminado"
End Sub

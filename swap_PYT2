import PyPDF2
from reportlab.pdfgen import canvas
from reportlab.lib.pagesizes import A4
from io import BytesIO

def superponer_grilla_sobre_pdf(pdf_existente, pdf_salida, desplazamiento_superior=50, desplazamiento_inferior=-50):
    # Abrir el PDF existente
    pdf_reader = PyPDF2.PdfReader(open(pdf_existente, "rb"))
    num_pages = len(pdf_reader.pages)
    
    # Crear un PDF writer para el resultado final
    pdf_writer = PyPDF2.PdfWriter()
    
    for page_num in range(num_pages):
        # Crear un buffer temporal para almacenar el PDF con la cuadrícula
        packet = BytesIO()
        temp_canvas = canvas.Canvas(packet, pagesize=A4)
        width, height = A4
        
        step = 20  # Ajusta el paso para la cuadrícula (cada 20 puntos)
        
        # Ajustar la cuadrícula para que empiece más arriba o más abajo
        for x in range(0, int(width), step):
            temp_canvas.drawString(x, height - 10, str(x))  # Coordenadas X
            temp_canvas.line(x, desplazamiento_inferior, x, height - desplazamiento_superior)
        
        for y in range(desplazamiento_inferior, int(height) - desplazamiento_superior, step):
            temp_canvas.drawString(5, y, str(y))  # Coordenadas Y
            temp_canvas.line(0, y, width, y)
        
        # Guardar la página de cuadrícula en el buffer temporal
        temp_canvas.save()

        # Obtener la página de cuadrícula desde el buffer temporal
        packet.seek(0)
        new_pdf = PyPDF2.PdfReader(packet)

        # Extraer la página del PDF existente
        original_page = pdf_reader.pages[page_num]

        # Combinar la página original con la nueva página de cuadrícula
        original_page.merge_page(new_pdf.pages[0])

        # Agregar la página combinada al escritor del nuevo PDF
        pdf_writer.add_page(original_page)
    
    # Guardar el nuevo PDF con la cuadrícula superpuesta
    with open(pdf_salida, "wb") as output_file:
        pdf_writer.write(output_file)

# Ejecutar la función con el PDF original y el nuevo PDF de salida
pdf_existente = 'tu_pdf_modelo.pdf'
pdf_salida = 'pdf_con_grilla_completa.pdf'

# Usamos desplazamiento_superior y desplazamiento_inferior para ajustar toda la grilla
superponer_grilla_sobre_pdf(pdf_existente, pdf_salida, desplazamiento_superior=30, desplazamiento_inferior=-50)
